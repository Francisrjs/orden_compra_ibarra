<app-pop-up-ng
  [show]="showModal"
  [titleModal]="titleModal"
  [description]="descriptionModal"
  [inputType]="typeModal"
  [type]="type"
  [numberMin]="0"
  [prefix]="prefix"
  [numberPlaceholder]="numberPlaceHolder"
  (onAccept)="handleAccept($event)"
  (onCancel)="handleCancel()"
  [dropdownOptions]="dropdownOptions"
  [dropdownPlaceholder]="dropdownPlaceholder"
  [dropdownOptionLabel]="dropdownOptionLabel"
  [dropdownOptionValue]="dropdownOptionValue"
></app-pop-up-ng>
<div *ngIf="dataOrden; else noInfo">
  <h2 class="text-center mb-4 d-flex align-items-center justify-content-center">
    <span>{{ dataOrden.numero_oc }}</span>
    <span class="badge ms-2 fs-6" [ngClass]="getBadgeClass(dataOrden.estado)">
      {{ dataOrden.estado }}
    </span>
  </h2>
  <p-dialog
    header="Agregar/Editar factura y remito"
    [(visible)]="showAddFactura"
    [modal]="true"
    [closable]="false"
    [style]="{ width: '550px' }"
  >
    <div class="p-fluid" [formGroup]="facturaForm">
      <div class="d-flex">
        <i
          class="bi bi-asterisk text-danger fs-6 mx-1"
          style="font-size: 0.85rem"
        ></i>
        <label class="mb-2">Fecha de la factura:</label>
      </div>
      <app-input-date
        id="fecha_factura"
        formControlName="fecha"
        [max]="maxDate"
      ></app-input-date>
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center">
          <i
            class="bi bi-asterisk text-danger fs-6 mx-1"
            style="font-size: 0.85rem"
          ></i>
          <label class="mb-0">Numero de Factura</label>
        </div>
        <span class="badge bg-info text-dark">
          <i class="bi bi-info-circle me-1"></i>
          Ejemplo: 0001-111133
        </span>
      </div>

      <!-- Usamos p-inputNumber (si lo importaste) -->
      <p-inputNumber
        formControlName="primerosDigitosFactura"
        [min]="1"
        [mode]="'decimal'"
        [minFractionDigits]="0"
        [maxFractionDigits]="0"
        placeholder="0001 (Punto de venta)"
        inputId="primerDigitoFactura"
        class="mb-2"
        (keydown.enter)="onEnterPrecio()"
      />
      <small class="text-muted d-block mb-2">
        <i class="bi bi-arrow-return-right me-1"></i>
        Punto de venta: primeros dígitos antes del guión
      </small>

      <div class="d-flex">
        <i
          class="bi bi-asterisk text-danger fs-6 mx-1"
          style="font-size: 0.85rem"
        ></i>
        <label class="mb-2">Últimos dígitos</label>
      </div>

      <p-inputNumber
        formControlName="ultimosDigitosFactura"
        [min]="1"
        [mode]="'decimal'"
        [minFractionDigits]="0"
        [maxFractionDigits]="0"
        placeholder="111133 (Número de factura)"
        inputId="segundoDigitoFacturas"
        class="mb-2"
        (keydown.enter)="onEnterPrecio()"
      />
      <small class="text-muted d-block mb-3">
        <i class="bi bi-arrow-return-right me-1"></i>
        Número de factura: últimos dígitos después del guión
      </small>

      <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="mb-0">Remitos:</label>
        <button
          type="button"
          class="btn btn-success btn-sm"
          (click)="openAddRemito()"
        >
          <i class="bi bi-plus me-1"></i>
          Agregar
        </button>
      </div>

      <app-table-generic-ng
        [columns]="[
          { field: 'id', header: 'ID', width: '2rem' },
          { field: 'numero_remito', header: 'NRO REMITO', width: '20rem' },
          { field: 'fecha', header: 'Fecha', pipe: formatDate }
        ]"
        [data]="_remitoService.remitos"
      >
        <ng-template #actions let-item>
          <p-button
            icon="pi pi-trash"
            (onClick)="this._remitoService.deleteItemRemito(item)"
            styleClass="p-button-rounded p-button-outlined"
            [rounded]="true"
            [text]="true"
            severity="danger"
          ></p-button> </ng-template
      ></app-table-generic-ng>
      <div class="d-flex mt-2">
        <i
          class="bi bi-asterisk text-danger fs-6 mx-1"
          style="font-size: 0.85rem"
        ></i>
        <label class="mb-2">Importe total</label>
      </div>

      <p-inputNumber
        formControlName="importe"
        [min]="1"
        mode="decimal"
        prefix="$"
        [minFractionDigits]="0"
        [maxFractionDigits]="2"
        placeholder="Ingrese el importe"
        inputId="importe"
        class="mb-2"
      />
      <small class="text-muted d-block mb-3">
        <i class="bi bi-arrow-return-right me-1"></i>
        Importe total sin iva
      </small>
      <div class="d-flex justify-center text-center my-2">
        <i
          class="bi bi-asterisk text-danger fs-6 mx-1"
          style="font-size: 0.85rem"
        ></i>
        <label class="mb-2">Campos Obligatorios</label>
      </div>
      <div class="d-flex justify-content-end gap-2 mt-3">
        <button
          pButton
          type="button"
          label="Cancelar"
          class="p-button-text"
          (click)="cancelAdd()"
        ></button>
        <button
          pButton
          type="button"
          label="Aceptar"
          (click)="addEditFactura()"
          [disabled]="!isPrecioValid()"
        ></button>
      </div>
    </div>
  </p-dialog>

  <!-- Modal para agregar remito -->
  <p-dialog
    header="Agregar Remito"
    [(visible)]="showAddRemito"
    [modal]="true"
    [closable]="false"
    [style]="{ width: '400px' }"
  >
    <div class="p-fluid" [formGroup]="remitoForm">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center">
          <i
            class="bi bi-asterisk text-danger fs-6 mx-1"
            style="font-size: 0.85rem"
          ></i>
          <label class="mb-0">Número de Remito</label>
        </div>
        <span class="badge bg-info text-dark">
          <i class="bi bi-info-circle me-1"></i>
          Ejemplo: 0001-111133
        </span>
      </div>

      <p-inputNumber
        formControlName="puntoVentaRemito"
        [min]="1"
        [mode]="'decimal'"
        [minFractionDigits]="0"
        [maxFractionDigits]="0"
        placeholder="0001 (Punto de venta)"
        class="mb-2"
      />
      <small class="text-muted d-block mb-2">
        <i class="bi bi-arrow-return-right me-1"></i>
        Punto de venta: primeros dígitos antes del guión
      </small>

      <div class="d-flex">
        <i
          class="bi bi-asterisk text-danger fs-6 mx-1"
          style="font-size: 0.85rem"
        ></i>
        <label class="mb-2">Número de remito</label>
      </div>

      <p-inputNumber
        formControlName="numeroRemito"
        [min]="1"
        [mode]="'decimal'"
        [minFractionDigits]="0"
        [maxFractionDigits]="0"
        placeholder="111133 (Número de remito)"
        class="mb-2"
      />
      <small class="text-muted d-block mb-3">
        <i class="bi bi-arrow-return-right me-1"></i>
        Número de remito: últimos dígitos después del guión
      </small>
      <div class="d-flex">
        <i
          class="bi bi-asterisk text-danger fs-6 mx-1"
          style="font-size: 0.85rem"
        ></i>
        <label class="mb-2">Fecha del remito:</label>
      </div>
      <app-input-date
        id="fecha_remito"
        formControlName="fecha"
        [max]="maxDate"
      ></app-input-date>
      <div class="d-flex justify-center text-center my-2">
        <i
          class="bi bi-asterisk text-danger fs-6 mx-1"
          style="font-size: 0.85rem"
        ></i>
        <label class="mb-2">Campos Obligatorios</label>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <button
          pButton
          type="button"
          label="Cancelar"
          class="p-button-text"
          (click)="cancelAddRemito()"
        ></button>
        <button
          pButton
          type="button"
          label="Agregar"
          (click)="agregarRemito()"
          [disabled]="!remitoForm.valid"
        ></button>
      </div>
    </div>
  </p-dialog>

  <div class="row justify-content-center mb-3">
    <div class="col-md-5 mb-2">
      <app-custom-button
        text="Agregar factura"
        icon="bi-paperclip"
        type="submit"
        styleType="warning"
        (buttonClick)="showAddFactura = true"
        pTooltip="Agregar una nueva factura a esta orden de compra"
        tooltipPosition="top"
      />
    </div>
    <div class="col-md-5 mb-2">
      <app-custom-button
        text="Cancelar"
        icon="bi-ban"
        type="submit"
        styleType="danger"
        pTooltip="Cancelar la orden de compra actual"
        tooltipPosition="top"
      />
    </div>
    <div class="col-md-5 mb-2">
      <app-custom-button
        text="Cerrar"
        icon="bi-check2"
        type="submit"
        styleType="success"
        pTooltip="Cerrar y finalizar la orden de compra"
        tooltipPosition="top"
      />
    </div>
  </div>
  <p-divider></p-divider>
  <!-- Estado: Abierto -->
  <div class="row justify-content-center mb-3">
    <div class="col-md-3 mb-2">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="bi bi-calendar" style="font-size: 1.5rem"></i>
          <div class="mt-2">
            <b>Creación:</b> <br />
            {{ dataOrden.fecha_creacion | date : "shortDate" }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-2">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="bi bi-truck" style="font-size: 1.5rem"></i>
          <div class="mt-2">
            <b>Entrega:</b> <br />
            {{ dataOrden.condicion_entrega }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-2">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="bi bi-wallet" style="font-size: 1.5rem"></i>
          <div class="mt-2">
            <b>Pago:</b> <br />
            {{ dataOrden.condicion_pago }}
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Estado: EN PROCESO -->
  <!-- <div class="row justify-content-center mb-3">
    <div class="col-md-3 mb-2" *ngIf="dataOrden.factura">
      <div class="card text-center border-0 shadow-sm" >
        <div class="card-body">
          <i class="bi bi-file" style="font-size: 1.5rem;"></i>
          <div class="mt-2"><b>Factura:</b> <br> {{dataOrden.factura}}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-2" *ngIf="dataOrden.remito" >
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="bi bi-file" style="font-size: 1.5rem;"></i>
          <div class="mt-2"> <b>Remito:</b> <br> {{dataOrden.remito}}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-2" *ngIf="dataOrden.fecha_pago">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="bi bi-wallet" style="font-size: 1.5rem;"></i>
          <div class="mt-2"><b>Fecha pago:</b> <br> {{dataOrden.fecha_pago}}</div>
        </div>
      </div>
    </div>
  </div> -->
  <!-- Estado: Información -->
  <div class="row justify-content-center">
    <div class="col-md-5 mb-3">
      <div class="card shadow-sm border-0">
        <div
          class="card-header bg-primary text-white d-flex align-items-center"
        >
          <i class="bi bi-person-circle me-2" style="font-size: 2rem"></i>
          <span class="fs-5">Proveedor</span>
        </div>
        <div class="card-body">
          <p class="mb-2">
            <i class="bi bi-person-fill text-primary me-2"></i>
            <strong>Nombre:</strong>
            {{ dataOrden.proveedor_id?.nombre || "Sin nombre" }}
          </p>
          <p class="mb-2">
            <i class="bi bi-credit-card-2-front text-primary me-2"></i>
            <strong>CUIT:</strong>
            {{ dataOrden.proveedor_id?.cuit || "Sin CUIT" }}
          </p>
          <p class="mb-0">
            <i class="bi bi-envelope-fill text-primary me-2"></i>
            <strong>Email:</strong>
            {{ dataOrden.proveedor_id?.email || "Sin email" }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-5 mb-3">
      <div class="card shadow-sm border-0">
        <div
          class="card-header bg-secondary text-white d-flex align-items-center"
        >
          <i class="bi bi-person-badge me-2" style="font-size: 2rem"></i>
          <span class="fs-5">Jefe de Compras</span>
        </div>
        <div class="card-body">
          <p class="mb-2">
            <i class="bi bi-person-fill text-secondary me-2"></i>
            <strong>Nombre:</strong>
            {{
              dataOrden.jefe_compra_id?.user_metadata ||
                dataOrden.jefe_compra_id ||
                "Sin nombre"
            }}
          </p>
          <p class="mb-0">
            <i class="bi bi-envelope-fill text-secondary me-2"></i>
            <strong>Email:</strong>
            {{ dataOrden.jefe_compra_id?.email || "Sin email" }}
          </p>
        </div>
      </div>
    </div>
    <div class="d-flex justify-content-center align-items-center">
      <i class="bi bi-box-fill mx-2 mb-2" style="font-size: 1.5rem"></i>
      <h4 class="text-center">Items de la orden:</h4>
    </div>

    <p-divider></p-divider>
    <app-table-generic-ng
      [columns]="[
        {
          field: 'factura_id.numero_factura',
          header: 'Factura Relacionada',
          pipe: getFactura
        },
        { field: 'pedido_item_id.productos.nombre', header: 'Producto' },
        { field: 'pedido_item_id.unidad_medida_id.nombre', header: 'Medida' },
        { field: 'cantidad', header: 'Cantidad' },
        { field: 'subtotal', header: 'Importe', pipe: getTotalCurrency },
        { field: 'recibido', header: 'Recibido', pipe: getRecibido }
      ]"
      [data]="_ordenCompraService.ordenCompraItemsSignal"
      [showFooter]="true"
      [footerColumns]="['subtotal']"
      [footerLabel]="'Total General'"
      minWidth="40rem"
    >
      <ng-template #actions let-item>
        <p-button
          icon="pi pi-check"
          styleClass="p-button-rounded p-button-outlined"
          [rounded]="true"
          [text]="true"
          pTooltip="Item recibido"
          severity="success"
          tooltipPosition="left"
          (onClick)="openItemRecibidoModal(item)"
        ></p-button>
        <p-button
          icon="pi pi-file"
          styleClass="p-button-rounded p-button-outlined"
          [rounded]="true"
          tooltipPosition="left"
          [text]="true"
          pTooltip="Relacionar el item con una factura"
          (onClick)="openRelacionarFacturaModal(item)"
          severity="info"
        ></p-button>
        <p-button
          icon="pi pi-pencil"
          styleClass="p-button-rounded p-button-outlined"
          pTooltip="Editar precio del item"
          tooltipPosition="left"
          [rounded]="true"
          [text]="true"
          (onClick)="openEditOrdenCompraItem(item)"
          severity="warning"
        ></p-button>
      </ng-template>
    </app-table-generic-ng>

    <div class="d-flex justify-content-center align-items-center">
      <i class="bi bi-file-earmark-text-fill" style="font-size: 1.5rem"></i>
      <h4 class="text-center mt-2">Facturas:</h4>
    </div>

    <p-divider></p-divider>
    <app-table-generic-ng
      [columns]="[
        { field: 'fecha', header: 'Fecha', pipe: formatDateString },
        { field: 'numero_factura', header: 'Factura Relacionada' },
        { field: 'importe', header: 'Importe', pipe: getTotalCurrency },
        { field: 'fecha_pago', header: 'Fecha de pago', pipe: formatDateString }
      ]"
      [data]="_ordenCompraService.facturas"
      [showFooter]="true"
      [footerColumns]="['subtotal']"
      [footerLabel]="'Total General'"
      minWidth="40rem"
    >
      <ng-template #actions let-item>
        <p-button
          icon="pi pi-calendar"
          styleClass="p-button-rounded p-button-outlined"
          [rounded]="true"
          [text]="true"
          tooltipPosition="left"
          severity="success"
          pTooltip="Actualizar Fecha de Pago"
          (onClick)="openActualizarFechaPago(item)"
        ></p-button>
        <p-button
          icon="pi pi-pencil"
          styleClass="p-button-rounded p-button-outlined"
          [rounded]="true"
          [text]="true"
          tooltipPosition="left"
          pTooltip="Editar Factura"
          severity="warning"
          (onClick)="editarFactura(item)"
        ></p-button>
        <p-button
          icon="pi pi-trash"
          styleClass="p-button-rounded p-button-outlined"
          [rounded]="true"
          tooltipPosition="left"
          [text]="true"
          pTooltip="Eliminar Factura"
          severity="danger"
        ></p-button>
      </ng-template>
    </app-table-generic-ng>
  </div>

  <div class="d-flex justify-content-center align-items-center">
    <i class="bi bi-currency-dollar" style="font-size: 1.5rem"></i>
    <h4 class="text-center mt-2">Presupuestos:</h4>
  </div>

  <p-divider></p-divider>
  <app-table-generic-ng
    [columns]="[
      { field: 'pedido_item_id.productos.nombre', header: 'Producto' },
      { field: 'pedido_item_id.unidad_medida_id.nombre', header: 'Medida' },
      { field: 'cantidad', header: 'Cantidad' },
      { field: 'subtotal', header: 'Importe', pipe: getTotalCurrency }
    ]"
    [data]="_ordenCompraService.presupuestos"
    minWidth="40rem"
  >
  </app-table-generic-ng>
</div>

<ng-template #noInfo>
  <h1>Sin Información a mostrar</h1>
</ng-template>
