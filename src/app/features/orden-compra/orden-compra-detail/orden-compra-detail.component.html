<p-toast></p-toast>
<app-sidebar
  [(isVisible)]="sidebarVisible"
  [title]="sidebarTitle"
  [componentToLoad]="componentToLoad"
  [componentInputs]="sidebarInputs"
></app-sidebar>
<app-pop-up-ng
  [show]="showModal"
  [titleModal]="titleModal"
  [description]="descriptionModal"
  [inputType]="typeModal"
  [type]="type"
  [numberMin]="0"
  [prefix]="prefix"
  [numberPlaceholder]="numberPlaceHolder"
  (onAccept)="handleAccept($event)"
  (onCancel)="handleCancel()"
  [dropdownOptions]="dropdownOptions"
  [dropdownPlaceholder]="dropdownPlaceholder"
  [dropdownOptionLabel]="dropdownOptionLabel"
  [dropdownOptionValue]="dropdownOptionValue"
></app-pop-up-ng>
<div *ngIf="dataOrden; else noInfo">
<div class="title mb-4 text-center">
  <h2 class="d-flex align-items-center justify-content-center gap-2 mb-2">
    <span>{{ dataOrden.numero_oc }}</span>
    <span class="badge fs-6" [ngClass]="getBadgeClass(dataOrden.estado)">
      {{ dataOrden.estado }}
    </span>
  </h2>
  <span class="text-secondary d-block">{{dataOrden.titulo}}</span>
</div>


  

<app-factura-form-dialog
  *ngIf="dataOrden"
  [(visible)]="showAddFactura"
  [facturaData]="facturaToEdit"
  [ordenCompraId]="dataOrden.id"
  [isOrdenFinalizada]="isOrdenFinalizada()"
  (onSave)="handleFacturaSaved($event)"
  (onAddItem)="addOrdenCompraItem()"
  (onEditItem)="openEditPriceItemFacturaSignal($event)"
  (onDeleteItem)="eliminarItemTemporal($event)"
  (onAddRemito)="showAddRemito = true"
></app-factura-form-dialog>

<app-remito-form-dialog
  [(visible)]="showAddRemito"
  [isDisabled]="isOrdenFinalizada()"
  (onSave)="handleRemitoSaved($event)"
></app-remito-form-dialog>

  <p-divider></p-divider>
  
  <!-- Layout con 2 columnas: Cards info en centro (col-8) y Personas a la derecha (col-4) -->
  <div class="row mb-3">

    <!-- COLUMNA IZQUIERDA/CENTRO: Cards de información -->
    <div class="col-lg-8 mt-5">

      <!-- Fila 1: Creación, Entrega, Pago -->
      <div class="row justify-content-center mb-3">
        <div class="col-md-4 mb-2">
          <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body">
              <i class="bi bi-calendar text-primary" style="font-size: 1.5rem"></i>
              <div class="mt-2">
                <b>Creación:</b> <br />
                {{ dataOrden.fecha_creacion | date : "dd/MM/yyyy" }}
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-2">
          <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body">
              <i class="bi bi-truck text-info" style="font-size: 1.5rem"></i>
              <div class="mt-2">
                <b>Entrega:</b> <br />
                {{ dataOrden.condicion_entrega }}
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-2">
          <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body">
              <i class="bi bi-wallet text-secondary" style="font-size: 1.5rem"></i>
              <div class="mt-2">
                <b>Pago:</b> <br />
                {{ dataOrden.condicion_pago }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fila 2: Presupuesto límite, Tipo OC, Saldo restante -->
      <div class="row justify-content-center">
        <div class="col-md-4 mb-2" *ngIf="dataOrden.presupuesto_limite">
          <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body">
              <i class="bi bi-currency-dollar text-success" style="font-size: 1.5rem"></i>
              <div class="mt-2">
                <b>Presupuesto límite:</b> <br />
                {{ dataOrden.presupuesto_limite | currency : "$" }}
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-2">
          <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body">
              <i class="bi bi-card-text text-success" style="font-size: 1.5rem"></i>
              <div class="mt-2">
                <b>Tipo OC:</b> <br />
                {{ dataOrden.tipo }}
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-2" *ngIf="dataOrden.presupuesto_limite">
          <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body">
              <i class="bi bi-currency-dollar text-warning" style="font-size: 1.5rem"></i>
              <div class="mt-2">
                <b>Saldo restante:</b> <br />
                {{ (dataOrden.presupuesto_limite - getImporteTotalOC()) | currency : "$" }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- COLUMNA DERECHA: Proveedor y Jefe de Compras -->
    <div class="col-lg-4">
      <!-- Card Proveedor -->
      <div class="mb-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-primary text-white d-flex align-items-center">
            <i class="bi bi-person-circle me-2" style="font-size: 1.5rem"></i>
            <span class="fs-6">Proveedor</span>
          </div>
          <div class="card-body">
            <p class="mb-2">
              <i class="bi bi-person-fill text-primary me-2"></i>
              <strong>Nombre:</strong>
              {{ dataOrden.proveedor_id?.nombre || "Sin nombre" }}
            </p>
            <p class="mb-2">
              <i class="bi bi-credit-card-2-front text-primary me-2"></i>
              <strong>CUIT:</strong>
              {{ dataOrden.proveedor_id?.cuit || "Sin CUIT" }}
            </p>
            <p class="mb-0">
              <i class="bi bi-envelope-fill text-primary me-2"></i>
              <strong>Email:</strong>
              {{ dataOrden.proveedor_id?.email || "Sin email" }}
            </p>
          </div>
        </div>
      </div>

      <!-- Card Jefe de Compras -->
      <div class="mb-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-secondary text-white d-flex align-items-center">
            <i class="bi bi-person-badge me-2" style="font-size: 1.5rem"></i>
            <span class="fs-6">Jefe de Compras</span>
          </div>
          <div class="card-body">
            <p class="mb-2">
              <i class="bi bi-person-fill text-secondary me-2"></i>
              <strong>Nombre:</strong>
              {{
                dataOrden.jefe_compra_id.user_metadata ||
                dataOrden.jefe_compra_id ||
                "Sin nombre"
              }}
          </p>
          <p class="mb-0">
            <i class="bi bi-envelope-fill text-secondary me-2"></i>
            <strong>Email:</strong>
            {{ dataOrden.jefe_compra_id.email || "Sin email" }}
          </p>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- Sección de Items de la orden -->
   <div class="card">

   
   <p-tabView styleClass="tabview-custom">
    <p-tabPanel>
        <ng-template pTemplate="header" style="color:none">
            <i class="pi pi-box mx-1 "></i>
            <span>Items de la orden</span>
        </ng-template>
          <div class="col-12">
      <div class="d-flex justify-content-center align-items-center">
        <i class="bi bi-box-fill mx-2 mb-2" style="font-size: 1.5rem"></i>
        <h4 class="text-center">Items de la orden:</h4>
      </div>
      <p-divider></p-divider>
  
    <app-table-generic-ng
      [columns]="[
        {
          field: 'factura_id.numero_factura',
          header: 'Factura Relacionada',
          pipe: getFactura
        },
        { field: 'pedido_item_id.productos.nombre', header: 'Producto' },
        { field: 'pedido_item_id.unidad_medida_id.nombre', header: 'Medida' },
        { field: 'cantidad', header: 'Cantidad' },
        { field: 'subtotal', header: 'Importe', pipe: getTotalCurrency },
        { field: 'recibido', header: 'Recibido', pipe: getRecibido }
      ]"
      [data]="_ordenCompraService.ordenCompraItemsSignal"
      [showFooter]="true"
      [footerColumns]="['subtotal']"
      [footerLabel]="'Total General'"
      (addButtonClick)="addOrdenCompraItem()"
      minWidth="40rem"
      [addButton]="dataOrden.tipo=='ABIERTA'&& dataOrden.estado!='FINALIZADA'"
    >
      <ng-template #actions let-item>
        <p-button
          icon="pi pi-check"
          styleClass="p-button-rounded p-button-outlined"
          [rounded]="true"
          [text]="true"
          pTooltip="Item recibido"
          severity="success"
          tooltipPosition="left"
          (onClick)="openItemRecibidoModal(item)"
          [disabled]="isOrdenFinalizada()"
        ></p-button>
        <p-button
          icon="pi pi-file"
          styleClass="p-button-rounded p-button-outlined"
          [rounded]="true"
          tooltipPosition="left"
          [text]="true"
          pTooltip="Relacionar el item con una factura"
          (onClick)="openRelacionarFacturaModal(item)"
          severity="info"
          [disabled]="isOrdenFinalizada()"
        ></p-button>
        <p-button
          icon="pi pi-pencil"
          styleClass="p-button-rounded p-button-outlined"
          pTooltip="Editar precio del item"
          tooltipPosition="left"
          [rounded]="true"
          [text]="true"
          (onClick)="openEditOrdenCompraItem(item)"
          severity="warning"
          [disabled]="isOrdenFinalizada()"
        ></p-button>
      </ng-template>
    </app-table-generic-ng>


  </div>
    </p-tabPanel>
    <p-tabPanel header="Header II">
        <ng-template pTemplate="header">
            <i class="pi pi-file mx-2"></i>
            <span>Facturas</span>
        </ng-template>
           <div class="d-flex justify-content-center align-items-center">
      <i class="bi bi-file-earmark-text-fill" style="font-size: 1.5rem"></i>
      <h4 class="text-center mt-2 mx-2">Facturas:</h4>
    </div>

    <p-divider></p-divider>
    <app-table-generic-ng
      [columns]="[
        { field: 'fecha', header: 'Fecha', pipe: formatDateString },
        { field: 'numero_factura', header: 'Factura Relacionada' },
        { field: 'importe', header: 'Importe', pipe: getTotalCurrency },
        { field: 'fecha_pago', header: 'Fecha de pago', pipe: formatDateString }
      ]"
      [data]="_ordenCompraService.facturas"
      [showFooter]="true"
      [footerColumns]="['importe']"
      [footerLabel]="'Total General'"
      minWidth="40rem"
      (addButtonClick)="openModalFactura()"
      [addButton]="dataOrden.estado!='FINALIZADA'"
    >
      <ng-template #actions let-item>
        <p-button
          icon="pi pi-calendar"
          styleClass="p-button-rounded p-button-outlined"
          [rounded]="true"
          [text]="true"
          tooltipPosition="left"
          severity="success"
          pTooltip="Actualizar Fecha de Pago"
          (onClick)="openActualizarFechaPago(item)"
          [disabled]="isOrdenFinalizada()"
        ></p-button>
        <p-button
          icon="pi pi-pencil"
          styleClass="p-button-rounded p-button-outlined"
          [rounded]="true"
          [text]="true"
          tooltipPosition="left"
          pTooltip="Editar Factura"
          severity="warning"
          (onClick)="editarFactura(item)"
          [disabled]="isOrdenFinalizada()"
        ></p-button>
        <p-button
          icon="pi pi-trash"
          styleClass="p-button-rounded p-button-outlined"
          [rounded]="true"
          tooltipPosition="left"
          [text]="dataOrden.estado!='FINALIZADA'"
          pTooltip="Eliminar Factura"
          severity="danger"
          [disabled]="isOrdenFinalizada()"
        ></p-button>
      </ng-template>
    </app-table-generic-ng>
    </p-tabPanel>
    <p-tabPanel header="Header IV">
        <ng-template pTemplate="header">
            <i class="pi pi-folder mx-2"></i>
            <span>Presupuestos</span>
        </ng-template>
         <div class="d-flex justify-content-center align-items-center">
          <i class="bi bi-folder mx-2" style="font-size: 1.5rem"></i>
          <h4 class="text-center mt-2">Presupuestos:</h4>
  </div>

  <p-divider></p-divider>
  <app-table-generic-ng
    [columns]="[
      { field: 'pedido_item_id.productos.nombre', header: 'Producto' },
      { field: 'pedido_item_id.unidad_medida_id.nombre', header: 'Medida' },
      { field: 'cantidad', header: 'Cantidad' },
      { field: 'subtotal', header: 'Importe', pipe: getTotalCurrency }
    ]"
    [data]="_ordenCompraService.presupuestos"
    minWidth="40rem"
    [addButton]="dataOrden.estado!='FINALIZADA'"
  >
  </app-table-generic-ng>
    </p-tabPanel>
    <p-tabPanel header="Header IV">
        <ng-template pTemplate="header">
            <i class="pi pi-search mx-2"></i>
            <span>Remitos </span>
        
        </ng-template>
         <div class="d-flex justify-content-center align-items-center">
    <i class="bi bi-search mx-2" style="font-size: 1.5rem"></i>
    <h4 class="text-center mt-2">Remitos:</h4>
  </div>

  <p-divider></p-divider>
  <app-table-generic-ng
    [columns]="[
      { field: 'numero_remito', header: 'Número Remito' },
      { field: 'numero_factura', header: 'Factura Relacionada' },
      { field: 'fecha', header: 'Fecha', pipe: formatDateString }
    ]"
    [data]="_ordenCompraService.remitos()"
    minWidth="40rem"
    [addButton]="dataOrden.estado!='FINALIZADA'"
  >
  </app-table-generic-ng>
    </p-tabPanel>
</p-tabView>
</div>
  <div
    class="row justify-content-around align-items-center mb-3 mt-2"
    *ngIf="dataOrden.estado != 'FINALIZADA'"
  >
  
    <div class="col-md-5 mb-2 w-25">
      <app-custom-button
        text="Cancelar"
        icon="bi-ban"
        type="submit"
        styleType="danger"
        pTooltip="Cancelar la orden de compra actual"
        tooltipPosition="top"
        [disabled]="isOrdenFinalizada()"
      />
    </div>
    <div class="col-md-5 mb-2 w-25">
      <app-custom-button
        text="Finalizar"
        icon="bi-check2"
        type="submit"
        styleType="success"
        pTooltip="Solo podra cerrar la OC, si todos los elementos fueron entregados"
        tooltipPosition="top"
        [disabled]="!todosLosItemsRecibidos() || isOrdenFinalizada()"
        (buttonClick)="finalizarOrdenCompra()"
      />
    </div>
  </div>
  </div>
  

<ng-template #noInfo>
  <h1>Sin Información a mostrar</h1>
</ng-template>
