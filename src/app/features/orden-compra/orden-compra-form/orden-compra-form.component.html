<p-dialog
  header="Precio del Objeto/Servicio"
  [(visible)]="showPriceDialog"
  [modal]="true"
  [closable]="false"
  [style]="{ width: '350px' }"
>
  <div class="p-fluid">
    <label class="mb-2">Precio</label>

    <!-- Usamos p-inputNumber (si lo importaste) -->
    <p-inputNumber
      [(ngModel)]="precioAsignado"
      [min]="0"
      [mode]="'decimal'"
      [minFractionDigits]="0"
      [maxFractionDigits]="2"
      placeholder="Ingrese el precio"
      inputId="precioInput"
    >
    </p-inputNumber>

    <!-- Alternativa simple si no tenés p-inputNumber:
    <input type="number" step="0.01" class="form-control" [(ngModel)]="precioAsignado" /> 
    -->

    <div class="d-flex justify-content-end gap-2 mt-3">
      <button
        pButton
        type="button"
        label="Cancelar"
        class="p-button-text"
        (click)="cancelAdd()"
      ></button>
      <button
        pButton
        type="button"
        label="Aceptar"
        (click)="confirmAddWithPrice()"
        [disabled]="!isPrecioValid()"
      ></button>
    </div>
  </div>
</p-dialog>
<div class="d-flex gap-5">
  <div class="w-75">
    <h4>Formulario de orden de compra:</h4>
    <div class="w-50">
      <app-input-box
        label="Proveedor"
        type="text"
        id="title"
        placeholder="Ingres el proveedor.. Ej La Lucy.."
      ></app-input-box>
    </div>

    <div class="container-header min-vh-25" style="min-width: 350px">
      <h5 class="fw-bold">Productos/Servicios Agregados</h5>
      <div class="d-flex align-items-center mt-3 gap-2">
        <div class="input-group flex-grow-1">
          <span class="input-group-text bg-light border-end-0" id="search-icon">
            <i class="bi bi-search"></i>
          </span>
          <input
            type="text"
            class="form-control border-start-0"
            placeholder="Buscar producto..."
          />
        </div>
      </div>
    </div>
    <div class="container-body">
      <!-- ***** VISTA 1: Con productos ***** -->
      <div *ngIf="(pedidoItems?.length ?? 0) > 0">
        <ul class="list-group list-group-flush">
          <li
            class="list-group-item d-flex justify-content-between align-items-start product-card"
            *ngFor="let item of pedidoItems; trackBy: trackByItemId"
          >
            <div class="d-flex align-items-start gap-3">
              <div class="product-icon">
                <i
                  [ngClass]="
                    item.producto?.categoria?.icon_text || 'bi bi-box-seam'
                  "
                  class="fs-4"
                  aria-hidden="true"
                ></i>
              </div>

              <div class="product-info">
                <div class="d-flex align-items-center gap-2">
                  <h6 class="product-title mb-0">
                    {{ item.producto?.nombre }}
                  </h6>

                  <span
                    class="mx-2 badge"
                    [ngClass]="getBadgeClass(item?.estado, true)"
                    *ngIf="pedido()?.estado != 'En Creacion'"
                    >{{ item?.estado }}</span
                  >
                </div>

                <p
                  class="product-description mb-1"
                  *ngIf="item.producto?.descripcion"
                >
                  {{ item.producto?.descripcion }}
                </p>

                <!-- <div class="d-flex gap-3 align-items-center small text-muted">
                  <span><b>Cantidad:</b> {{ item.cantidad }}</span>
                  <span *ngIf="item.unidad_medida"
                    >| {{ item.unidad_medida?.nombre }}</span
                  >
                  <span *ngIf="item.razon_pedido"
                    >| <b>Razon:</b> {{ item.razon_pedido }}</span
                  >
                </div> -->
                <div class="d-flex gap-3 align-items-center small text-muted">
                  <span><b>Cantidad:</b> {{ item.cantidad }}</span>
                  <span *ngIf="item.unidad_medida"
                    >| {{ item.unidad_medida?.nombre }}</span
                  >
                  <span *ngIf="item.razon_pedido"
                    >| <b>Razon:</b> {{ item.razon_pedido }}</span
                  >

                  <!-- CORREGIDO: sin cast en el template -->
                  <span *ngIf="item.precio_asignado != null">
                    | <b>Precio:</b> {{ item.precio_asignado | currency }}
                  </span>
                </div>
              </div>
            </div>

            <div class="product-actions d-flex gap-2 align-items-center">
              <!-- Botón añadir (icono +) para acciones rápidas -->
              <p-button
                icon="pi pi-trash"
                styleClass="p-button-rounded p-button-outlined"
                [rounded]="true"
                [text]="true"
                severity="danger"
              ></p-button>

              <!-- Editar / Borrar solo si el pedido está en creación -->
              <ng-container *ngIf="pedido()?.estado == 'En Creacion'">
                <button
                  class="btn btn-sm btn-outline-warning"
                  title="Editar producto"
                  (click)="editProductItem(item)"
                >
                  <i class="bi bi-pencil"></i>
                </button>
                <button
                  class="btn btn-sm btn-outline-danger"
                  title="Eliminar producto"
                  (click)="deleteItemPedido(item.id)"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </ng-container>
            </div>
          </li>
        </ul>
      </div>

      <!-- Mensaje cuando no hay productos -->
      <!-- <ng-template #noProducts>
        <div class="no-products-placeholder text-center py-4">
          <div
            class="add-icon-circle mb-2"
            (click)="openPedidoProducto()"
            style="cursor: pointer"
          >
            <i class="bi bi-plus-lg fs-3"></i>
          </div>
          <p class="mt-2 text-muted">No hay productos agregados. Agregá uno.</p>
        </div>
      </ng-template> -->

      <!-- Botón finalizar pedido (solo se muestra cuando hay items y está en creación) -->
      <div
        class="mt-3 d-flex justify-content-end"
        *ngIf="pedidoItems.length > 0 && pedido()?.estado == 'En Creacion'"
      >
        <button class="btn btn-success">
          <i class="bi bi-check-lg me-2"></i> Finalizar pedido
        </button>
      </div>
    </div>

    <app-custom-button
      text="Guardar Orden de COmpra"
      type="submit"
      styleType="success"
    >
      ></app-custom-button
    >
  </div>

  <div class="">
    <h4>Items pendientes para OC:</h4>
    <app-table-ng-item-pedido
      (addItem)="handleItemAdd($event)"
    ></app-table-ng-item-pedido>
  </div>
</div>
